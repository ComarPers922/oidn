## Copyright 2009-2020 Intel Corporation
## SPDX-License-Identifier: Apache-2.0

stages:
  - build
  - test
  - package
  - scan_source

.base:
  variables:
    GIT_SUBMODULE_STRATEGY: recursive
    OIDN_ROOT_DIR:          "$CI_PROJECT_DIR"
    PYTHONUNBUFFERED:       1

.build:
  stage: build
  only:
    - pushes
    - schedules
    - web
  artifacts:
    untracked: true
    name:      "$CI_JOB_NAME"
    when:      always
    expire_in: 1d

.test:
  stage: test
  script:
      - scripts/build.py install
      - scripts/test.py
  only:
    - pushes
    - schedules
    - web
  artifacts:
    when: always
    paths:
      - test.log
    name: "$CI_JOB_NAME"

.package:
  stage: package
  script: scripts/build.py package
  only:
    - schedules
    - web
  artifacts:
    paths:
      - build/*.tar.gz
      - build/*.zip
    name:      "$CI_JOB_NAME"
    expire_in: 1d

## -----------------------------------------------------------------------------
## Linux
## -----------------------------------------------------------------------------
 
.base-linux:
  extends: .base
  tags:
    - docker

.build-linux:
  extends:
    - .build
    - .base-linux

.test-linux:
  extends:
    - .test
    - .base-linux

.package-linux:
  extends:
    - .package
    - .base-linux

## -----------------------------------------------------------------------------

.centos7:
  image: openimagedenoise/build:centos7
  
build-centos7-icc:
  extends:
    - .build-linux
    - .centos7
  script: scripts/build.py --compiler icc

test-centos7-icc:
  extends:
    - .test-linux
    - .centos7
  needs:
    - job: build-centos7-icc
      artifacts: true

package-linux:
  extends:
    - .package-linux
    - .centos7
  needs: 
    - job: build-centos7-icc
      artifacts: true

## -----------------------------------------------------------------------------

.ubuntu18.04:
  image: openimagedenoise/build:ubuntu18.04

build-ubuntu18.04-gcc:
  extends:
    - .build-linux
    - .ubuntu18.04
  script: scripts/build.py --compiler gcc

build-ubuntu18.04-gcc-debug:
  extends:
    - .build-linux
    - .ubuntu18.04
  script: scripts/build.py --compiler gcc --config Debug

build-ubuntu18.04-gcc-static:
  extends:
    - .build-linux
    - .ubuntu18.04
  script: scripts/build.py --compiler gcc -D OIDN_STATIC_LIB=ON

build-ubuntu18.04-clang:
  extends:
    - .build-linux
    - .ubuntu18.04
  script: scripts/build.py --compiler clang

build-ubuntu18.04-kw-gcc:
  extends:
    - .build-linux
    - .ubuntu18.04
  script: scripts/klocwork_build.sh

test-ubuntu18.04-gcc-debug:
  extends:
    - .test-linux
    - .ubuntu18.04
  needs:
    - job: build-ubuntu18.04-gcc-debug
      artifacts: true

## -----------------------------------------------------------------------------

.ubuntu20.04:
  image: openimagedenoise/build:ubuntu20.04

build-ubuntu20.04-gcc:
  extends:
    - .build-linux
    - .ubuntu20.04
  script:
    - mkdir build
    - cd build
    - cmake .. -D OIDN_APPS_OPENIMAGEIO=ON
    - make -j VERBOSE=1

test-ubuntu20.04-gcc:
  extends:
    - .test-linux
    - .ubuntu20.04
  needs:
    - job: build-ubuntu20.04-gcc
      artifacts: true

## -----------------------------------------------------------------------------
## macOS
## -----------------------------------------------------------------------------

.base-macos:
  extends: .base
  tags:
    - osx

.build-macos:
  extends:
    - .build
    - .base-macos

.test-macos:
  extends:
    - .test
    - .base-macos

.package-macos:
  extends:
    - .package
    - .base-macos

## -----------------------------------------------------------------------------

build-macos-icc:
  extends: .build-macos
  script:  scripts/build.py --compiler icc

build-macos-clang:
  extends: .build-macos
  script:  scripts/build.py --compiler clang

build-macos-clang-static:
  extends: .build-macos
  script:  scripts/build.py --compiler clang -D OIDN_STATIC_LIB=ON

test-macos-icc:
  extends: .test-macos
  needs:
    - job: build-macos-icc
      artifacts: true

test-macos-clang:
  extends: .test-macos
  needs:
    - job: build-macos-clang
      artifacts: true

package-macos:
  extends: .package-macos
  needs: 
    - job: build-macos-icc
      artifacts: true

## -----------------------------------------------------------------------------
## Windows
## -----------------------------------------------------------------------------

.base-windows:
  extends: .base
  tags:
    - win10
  variables:
    ErrorActionPreference: stop

.build-windows:
  extends:
    - .build
    - .base-windows

.test-windows:
  extends:
    - .test
    - .base-windows

.package-windows:
  extends:
    - .package
    - .base-windows

## -----------------------------------------------------------------------------

build-windows-icc:
  extends: .build-windows
  tags:
    - msvc15
    - icc19
  script:  python scripts/build.py --compiler msvc15-icc19

build-windows-msvc15:
  extends: .build-windows
  tags:
    - msvc15
  script:  python scripts/build.py --compiler msvc15

build-windows-msvc15-debug:
  extends: .build-windows
  tags:
    - msvc15
  script:  python scripts/build.py --compiler msvc15 --config Debug

build-windows-msvc15-static:
  extends: .build-windows
  tags:
    - msvc15
  script:  python scripts/build.py --compiler msvc15 -D OIDN_STATIC_LIB=ON

build-windows-msvc16:
  extends: .build-windows
  tags:
    - msvc16
  script:  python scripts/build.py --compiler msvc16

test-windows-icc:
  extends: .test-windows
  tags:
    - msvc15
    - icc19
  needs:
    - job: build-windows-icc
      artifacts: true

test-windows-msvc16:
  extends: .test-windows
  tags:
    - msvc16
  needs:
    - job: build-windows-msvc16
      artifacts: true

package-windows:
  extends: .package-windows
  tags:
    - msvc15
    - icc19
  needs:
    - job: build-windows-icc
      artifacts: true
      
## -----------------------------------------------------------------------------
## Protex
## -----------------------------------------------------------------------------

protex_scan:
  stage: scan_source
  tags:
    - docker
  only:
    - schedules
    - web
  script: scripts/protex_scan.sh
  image:  amd64/openjdk:8
  dependencies: []
  # Will fail regularly, do not break nightlies because of that.
  allow_failure: true
  artifacts:
    paths:     [ "$CI_PROJECT_DIR/ip_protex.log" ]
    name:      "$CI_JOB_NAME"
    when:      always
    expire_in: 7d
